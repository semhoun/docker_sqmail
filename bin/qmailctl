#!/bin/sh
PATH=/var/qmail/bin:/bin:/usr/bin:/usr/local/bin:/usr/local/sbin
export PATH

svclist="qmail-send qmail-smtpd qmail-smtpsd qmail-smtpsub spamd clamd dovecot lighttpd fcron"

case "$1" in
  start)
    echo "Starting qmail..."
    for svc in $svclist ; do
        if svok /service/$svc ; then
            svc -u /service/$svc
        else
            echo $svc service not running
        fi
    done
    ;;
  stop)
    echo "Stopping qmail..."
    for svc in $svclist ; do
      echo " $svc"
      svc -d /service/$svc
    done
    ;;
  stat)
    for svc in $svclist ; do
      svstat /service/$svc
      svstat /service/$svc/log
    done
    qmail-qstat
    ;;
  doqueue|alrm|flush)
    echo "Sending ALRM signal to qmail-send."
    svc -a /service/qmail-send
    ;;
  queue)
    qmail-qstat
    qmail-qread
    ;;
  reload|hup)
    echo "Sending HUP signal to qmail-send."
    svc -h /service/qmail-send
    ;;
  pause)
    for svc in $svclist ; do
      echo "Pausing $svc"
      svc -p /service/$svc
    done
    ;;
  cont)
    for svc in $svclist ; do
      echo "Continuing $svc"
      svc -c /service/$svc
    done
    ;;
  restart)
    echo "Restarting qmail:"
    for svc in $svclist ; do
      echo "* Stopping $svc."
      svc -d /service/$svc
    done
    echo "* Sending qmail-send SIGTERM and restarting."
    svc -t /service/qmail-send
    for svc in $svclist ; do
      echo "* Restarting $svc."
      svc -u /service/$svc
    done
    ;;
  cdb)
    /usr/local/bin/tcprules /var/qmail/control/rules.smtpd.cdb /var/qmail/control/rules.smtpd.tmp < /var/qmail/control/rules.smtpd
    chmod 644 /var/qmail/control/rules.smtpd.cdb
    /usr/local/bin/tcprules /var/qmail/control/rules.smtpsd.cdb /var/qmail/control/rules.smtpsd.tmp < /var/qmail/control/rules.smtpsd
    chmod 644 /var/qmail/control/rules.smtpsd.cdb
    /usr/local/bin/tcprules /var/qmail/control/rules.smtpsub.cdb /var/qmail/control/rules.smtpsub.tmp < /var/qmail/control/rules.smtpsub
    chmod 644 /var/qmail/control/rules.smtpsub.cdb
    echo "Reloaded rules.smtp(s).cdb ."
    ;;
  help)
    cat <<HELP
    stop -- stops mail service (smtp connections refused, nothing goes out)
   start -- starts mail service (smtp connection accepted, mail can go out)
   pause -- temporarily stops mail service (connections accepted, nothing leaves)
    cont -- continues paused mail service
    stat -- displays status of mail service
     cdb -- rebuild the tcpserver cdb file for smtp
 restart -- stops and restarts smtp, sends qmail-send a TERM & restarts it
 doqueue -- sends qmail-send ALRM, scheduling queued messages for delivery
  reload -- sends qmail-send HUP, rereading locals and virtualdomains
   queue -- shows status of queue
    alrm -- same as doqueue
   flush -- same as doqueue
     hup -- same as reload
    kill -- svc -d processes in svclist, the do 'killall -KILL '
HELP
    ;;
  kill)
    echo "First stopping services ... "
    for svc in $svclist ; do
        if svok /service/$svc ; then
            svc -d /service/$svc
        fi
    done
    echo "Now sending processes the kill signal ... "
    killall -KILL qmail-send qmail-lspawn qmail-remote qmail-rspawn qmail-smtpd
    echo "done"
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|doqueue|flush|reload|stat|pause|cont|cdb|queue|help|clear|kill}"
    exit 1
    ;;
esac

exit 0
